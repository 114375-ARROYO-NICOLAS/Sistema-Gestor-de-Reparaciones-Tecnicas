<div class="board-container p-3">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4 pb-3 border-bottom-1 surface-border">
    <div class="flex flex-column gap-2">
      <h2 class="text-3xl font-semibold m-0 text-color">Tablero de Presupuestos</h2>
      <span class="text-sm text-color-secondary">Gesti√≥n de presupuestos del sistema</span>
    </div>

    <div class="flex gap-3 align-items-center">
      <p-button
        label="Actualizar"
        icon="pi pi-refresh"
        [iconPos]="'left'"
        [loading]="loading()"
        (onClick)="refresh()"
        [disabled]="loading()">
      </p-button>

      <div class="flex align-items-center gap-2 px-3 py-2 border-round"
           [ngClass]="isConnected() ? 'bg-green-100' : 'bg-red-100'">
        <i class="pi"
           [ngClass]="isConnected() ? 'pi-wifi text-green-700' : 'pi-wifi-slash text-red-700'"></i>
        <span class="text-sm font-medium"
              [ngClass]="isConnected() ? 'text-green-700' : 'text-red-700'">
          {{ isConnected() ? 'Conectado' : 'Desconectado' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-column align-items-center justify-content-center py-8 gap-3">
      <p-progressSpinner
        [style]="{ width: '50px', height: '50px' }"
        strokeWidth="4"
        animationDuration="1s">
      </p-progressSpinner>
      <p class="text-lg text-color-secondary m-0">Cargando presupuestos...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="flex align-items-center gap-3 p-4 border-round bg-red-50 border-1 border-red-200 mb-3">
      <i class="pi pi-exclamation-triangle text-red-600 text-2xl"></i>
      <span class="flex-1 text-red-800">{{ error() }}</span>
      <p-button
        label="Reintentar"
        icon="pi pi-refresh"
        severity="danger"
        [outlined]="true"
        (onClick)="refresh()">
      </p-button>
    </div>
  }

  <!-- Kanban Board -->
  @if (!loading() && !error()) {
    <div cdkDropListGroup class="flex gap-3 overflow-x-auto pb-3" style="min-height: calc(100vh - 16rem);">
      @for (column of columns; track column.state) {
        <div class="flex-shrink-0" style="width: 260px;">
          <!-- Header de columna -->
          <div class="border-round-top p-3 border-1 border-bottom-none surface-100"
               [ngClass]="{
                 'border-orange-200': column.state === 'PENDIENTE',
                 'border-blue-200': column.state === 'EN_CURSO',
                 'border-purple-200': column.state === 'LISTO',
                 'border-orange-300': column.state === 'ENVIADO',
                 'border-green-200': column.state === 'APROBADO',
                 'border-red-200': column.state === 'RECHAZADO'
               }">
            <div class="flex align-items-center justify-content-between">
              <h3 class="text-base font-semibold m-0"
                  [ngClass]="{
                    'text-orange-600': column.state === 'PENDIENTE',
                    'text-blue-600': column.state === 'EN_CURSO',
                    'text-purple-600': column.state === 'LISTO',
                    'text-orange-700': column.state === 'ENVIADO',
                    'text-green-600': column.state === 'APROBADO',
                    'text-red-600': column.state === 'RECHAZADO'
                  }">
                {{ column.name }}
              </h3>
              <p-tag [value]="column.budgets.length.toString()"
                     [severity]="column.state === 'PENDIENTE' ? 'warn' :
                                 column.state === 'EN_CURSO' ? 'info' :
                                 column.state === 'LISTO' ? 'secondary' :
                                 column.state === 'ENVIADO' ? 'contrast' :
                                 column.state === 'APROBADO' ? 'success' : 'danger'">
              </p-tag>
            </div>
          </div>

          <!-- Drop zone -->
          <div
            cdkDropList
            [cdkDropListData]="column.budgets"
            [id]="'column-' + column.state"
            (cdkDropListDropped)="dropBudget($event, column)"
            class="surface-border border-1 border-round-bottom p-3 surface-ground"
            style="min-height: 400px; max-height: calc(100vh - 500px); overflow-y: auto;">
            @for (budget of column.budgets; track budget.id) {
              <div
                cdkDrag
                [cdkDragData]="budget"
                class="surface-card border-round shadow-1 p-2 mb-2 cursor-move hover:shadow-3 transition-duration-200"
                [class]="budget.estado === 'VENCIDO' ? 'border-2 border-orange-500' : 'border-1 surface-border'"
                (click)="viewBudgetDetail(budget.id, $event)">

                <!-- Header de la card -->
                <div class="flex justify-content-between align-items-start mb-2">
                  <p-tag [value]="budget.numeroPresupuesto" severity="info"></p-tag>
                </div>

                <!-- Cliente -->
                <div class="mb-1 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                  <span class="text-sm font-semibold text-900">{{ budget.clienteNombre }}</span>
                </div>

                <!-- Equipo -->
                <div class="mb-2 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                  <span class="text-sm text-700">{{ budget.equipoDescripcion }}</span>
                </div>

                <!-- Footer: Fecha y Usuario -->
                <div class="flex flex-column gap-2 pt-2 border-top-1 surface-border">
                  <div class="flex align-items-center gap-2 text-xs text-500">
                    <div class="flex align-items-center gap-1">
                      <i class="pi pi-calendar text-xs"></i>
                      <span>{{ budget.fechaCreacion | date: 'dd/MM/yyyy' }}</span>
                    </div>
                    @if (budget.fechaVencimiento) {
                      <div class="flex align-items-center gap-1">
                        <i class="pi pi-clock text-xs"></i>
                        <span>{{ budget.fechaVencimiento | date: 'dd/MM/yy' }}</span>
                      </div>
                    }
                    @if (budget.estado === 'VENCIDO') {
                      <div class="flex align-items-center gap-1">
                        <i class="pi pi-exclamation-triangle text-orange-600 text-xs"></i>
                        <span class="text-orange-600 text-xs font-semibold">Vencido</span>
                      </div>
                    }
                  </div>

                  <!-- Usuario asignado -->
                  <div class="flex align-items-center gap-1 text-xs">
                    @if (budget.empleadoNombre) {
                      <i class="pi pi-user text-xs text-600"></i>
                      <span class="text-600 font-medium overflow-hidden text-overflow-ellipsis white-space-nowrap">
                        {{ budget.empleadoNombre }}
                      </span>
                    } @else {
                      <span class="text-orange-600 font-medium">Sin asignar</span>
                    }
                  </div>
                </div>
              </div>
            }

            @if (column.budgets.length === 0) {
              <div class="text-center text-600 py-6">
                <i class="pi pi-inbox text-4xl mb-2" style="opacity: 0.3;"></i>
                <p class="text-sm m-0">No hay presupuestos</p>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
