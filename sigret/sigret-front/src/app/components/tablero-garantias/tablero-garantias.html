<div class="tablero-garantias-container p-4">
  <!-- Header -->
  <div class="flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div class="flex align-items-center gap-2">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        [rounded]="true"
        severity="secondary"
        (onClick)="goBack()">
      </p-button>
      <div>
        <h2 class="text-3xl font-bold text-900 m-0 mb-2 flex align-items-center gap-2">
          <i class="pi pi-shield text-primary"></i>
          Garantías
        </h2>
        <p class="text-600 m-0">Gestiona las garantías mediante arrastrar y soltar</p>
      </div>
    </div>

    <p-button
      label="Recargar"
      icon="pi pi-refresh"
      [outlined]="true"
      (onClick)="cargarGarantias()">
    </p-button>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-column align-items-center justify-content-center py-8 gap-3">
      <p-progressSpinner
        [style]="{ width: '50px', height: '50px' }"
        strokeWidth="4"
        animationDuration="1s">
      </p-progressSpinner>
      <p class="text-lg text-color-secondary m-0">Cargando garantías...</p>
    </div>
  }

  <!-- Contenido Principal -->
  @if (!loading()) {
    <!-- Zona de Garantías Nuevas (Recibidas) -->
    <div class="mb-4">
      <p-card class="bg-bluegray-50">
        <ng-template pTemplate="header">
          <div class="p-3 pb-0 border-bottom-1 surface-border">
            <div class="flex align-items-center justify-content-between">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-inbox text-bluegray-600 text-xl"></i>
                <h3 class="text-lg font-semibold m-0 text-bluegray-700">Garantías Recibidas</h3>
              </div>
              <p-tag [value]="garantiasRecibidas().length.toString()" severity="secondary"></p-tag>
            </div>
            <p class="text-sm text-600 m-0 mt-2">Arrastra las garantías a la columna "Esperando Evaluación" para comenzar el proceso</p>
          </div>
        </ng-template>

        <div
          cdkDropList
          [cdkDropListData]="garantiasRecibidas()"
          [cdkDropListConnectedTo]="getConnectedDropLists()"
          id="servicios-recibidos"
          (cdkDropListDropped)="dropServicio($event)"
          cdkDropListOrientation="horizontal"
          class="flex gap-3 overflow-x-auto py-2">

          @if (garantiasRecibidas().length === 0) {
            <div class="text-center text-500 py-4 w-full">
              <i class="pi pi-check-circle text-4xl mb-2 block text-300"></i>
              <p class="m-0">No hay garantías nuevas pendientes</p>
            </div>
          }

          @for (servicio of garantiasRecibidas(); track servicio.id) {
            <div
              cdkDrag
              [cdkDragData]="servicio"
              class="surface-card border-round shadow-2 p-2 cursor-move hover:shadow-4 transition-duration-200 flex-shrink-0"
              style="width: 220px;"
              (click)="verDetalle(servicio.id)">

              <!-- Header de la card -->
              <div class="flex justify-content-between align-items-start mb-2">
                <p-tag [value]="servicio.numeroServicio" severity="secondary" icon="pi pi-shield"></p-tag>
              </div>

              <!-- Cliente -->
              <div class="mb-1 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                <span class="text-sm font-semibold text-900">{{ servicio.clienteNombre }}</span>
              </div>

              <!-- Equipo -->
              <div class="mb-2 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                <span class="text-sm text-700">{{ servicio.equipoDescripcion }}</span>
              </div>

              <!-- Fecha de recepción -->
              <div class="flex align-items-center gap-2 pt-2 border-top-1 surface-border text-xs text-500">
                <div class="flex align-items-center gap-1">
                  <i class="pi pi-calendar text-xs"></i>
                  <span>{{ formatFecha(servicio.fechaRecepcion) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      </p-card>
    </div>

    <!-- Tablero Kanban -->
    <div cdkDropListGroup class="flex gap-3 overflow-x-auto pb-4">
      @for (columna of columnasConServicios(); track columna.estado) {
        <div class="flex-shrink-0" style="width: 260px;">
          <!-- Header de columna -->
          <div class="border-round-top p-3 border-1 border-bottom-none surface-100"
               [ngClass]="{
                 'border-orange-200': columna.estado === 'ESPERANDO_EVALUACION_GARANTIA',
                 'border-blue-200': columna.estado === 'EN_REPARACION',
                 'border-green-200': columna.estado === 'TERMINADO',
                 'border-cyan-200': columna.estado === 'GARANTIA_SIN_REPARACION',
                 'border-red-200': columna.estado === 'GARANTIA_RECHAZADA'
               }">
            <div class="flex align-items-center justify-content-between">
              <div class="flex align-items-center gap-2">
                <i [class]="'pi ' + columna.icon + ' ' + columna.color"></i>
                <h3 class="text-base font-semibold m-0" [ngClass]="columna.color">{{ columna.titulo }}</h3>
              </div>
              <p-tag [value]="columna.servicios.length.toString()" [severity]="getEstadoSeverity(columna.estado)"></p-tag>
            </div>
          </div>

          <!-- Drop zone -->
          <div
            cdkDropList
            [cdkDropListData]="columna.servicios"
            [id]="'columna-' + columna.estado"
            (cdkDropListDropped)="dropServicio($event, columna)"
            class="surface-border border-1 border-round-bottom p-3 surface-ground"
            style="min-height: 400px; max-height: calc(100vh - 500px); overflow-y: auto;">

            <!-- Cards de servicios -->
            @if (columna.servicios.length === 0) {
              <div class="text-center text-500 py-4">
                <i class="pi pi-inbox text-3xl mb-2 block text-400"></i>
                <p class="m-0 text-sm">Arrastra aquí</p>
              </div>
            }

            @for (servicio of columna.servicios; track servicio.id) {
              <div
                cdkDrag
                [cdkDragData]="servicio"
                class="surface-card border-round shadow-1 p-2 mb-2 cursor-move hover:shadow-3 transition-duration-200 border-1 surface-border"
                (click)="verDetalle(servicio.id)">

                <!-- Header de la card -->
                <div class="flex justify-content-between align-items-start mb-2">
                  <p-tag [value]="servicio.numeroServicio" severity="info" icon="pi pi-shield"></p-tag>
                </div>

                <!-- Cliente -->
                <div class="mb-1 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                  <span class="text-sm font-semibold text-900">{{ servicio.clienteNombre }}</span>
                </div>

                <!-- Equipo -->
                <div class="mb-2 overflow-hidden text-overflow-ellipsis white-space-nowrap">
                  <span class="text-sm text-700">{{ servicio.equipoDescripcion }}</span>
                </div>

                <!-- Fecha y Técnico -->
                <div class="flex align-items-center justify-content-between gap-2 pt-2 border-top-1 surface-border text-xs text-500">
                  <div class="flex align-items-center gap-1">
                    <i class="pi pi-calendar text-xs"></i>
                    <span>{{ formatFecha(servicio.fechaRecepcion) }}</span>
                  </div>
                  @if (servicio.tecnicoEvaluacionNombre || servicio.tecnicoAsignadoNombre) {
                    <div class="flex align-items-center gap-1">
                      <i class="pi pi-user text-xs"></i>
                      <span class="text-xs">{{ servicio.tecnicoAsignadoNombre || servicio.tecnicoEvaluacionNombre }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

</div>

<!-- Diálogo de evaluación de garantía -->
<app-evaluacion-garantia-dialog
  #evaluacionDialog
  (confirmed)="onEvaluacionConfirmada($event)"
  (cancelled)="onEvaluacionCancelada()">
</app-evaluacion-garantia-dialog>
