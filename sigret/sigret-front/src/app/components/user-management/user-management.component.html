<div class="user-management-container">
    <!-- Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-2xl font-bold text-900 m-0">Gestión de Usuarios</h2>
            <p class="text-600 mt-2">Administra los usuarios del sistema y sus
                permisos</p>
        </div>
        <p-button
            label="Ir a Gestión de Empleados"
            icon="pi pi-users"
            (click)="navigateToEmployees()"
            severity="secondary">
        </p-button>
    </div>

    <!-- Info Alert -->
    <div class="mb-4">
        <div class="bg-blue-50 p-3 border-round border-1 border-blue-200">
            <p class="text-sm text-blue-900 m-0">
                <i class="pi pi-info-circle mr-2"></i>
                <strong>Nota:</strong> Los usuarios se crean automáticamente al
                crear empleados.
                Desde aquí puedes editar roles, activar/desactivar usuarios y
                cambiar contraseñas.
                Para crear nuevos usuarios, ve a <strong>Gestión de
                    Empleados</strong>.
            </p>
        </div>
    </div>

    <!-- Users Table -->
    <p-card>
        <ng-template pTemplate="header">
            <div class="flex justify-content-between align-items-center p-4">
                <h3 class="text-xl font-semibold m-0">Lista de Usuarios</h3>
                <div class="flex gap-2">
                    <p-button
                        icon="pi pi-refresh"
                        severity="secondary"
                        text
                        (click)="loadUsers()"
                        [loading]="isLoading()"
                        title="Actualizar">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <ng-template pTemplate="content">
            <p-table
                [value]="users()"
                [paginator]="true"
                [rows]="pageSize"
                [totalRecords]="totalRecords()"
                [lazy]="true"
                (onLazyLoad)="loadUsers($event)"
                [loading]="isLoading()"
                styleClass="p-datatable-sm">

                <ng-template pTemplate="header">
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre Completo</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Fecha Creación</th>
                        <th>Último Login</th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-user>
                    <tr>
                        <td>
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-user text-primary"></i>
                                <span class="font-medium">{{ user.username
                                    }}</span>
                            </div>
                        </td>
                        <td>{{ user.nombreCompleto }}</td>
                        <td>
                            <p-tag
                                [value]="userService.getRoleDisplayName(user.rol)"
                                [severity]="userService.getRoleColor(user.rol)">
                            </p-tag>
                        </td>
                        <td>
                            <p-tag
                                [value]="user.activo ? 'Activo' : 'Inactivo'"
                                [severity]="user.activo ? 'success' : 'danger'">
                            </p-tag>
                        </td>
                        <td>{{ formatDate(user.fechaCreacion) }}</td>
                        <td>{{ user.ultimoLogin ? formatDate(user.ultimoLogin) :
                            'Nunca' }}</td>
                        <td>
                            <div class="flex gap-1">
                                <p-button
                                    icon="pi pi-pencil"
                                    severity="secondary"
                                    size="small"
                                    text
                                    (click)="openEditDialog(user)"
                                    title="Editar">
                                </p-button>

                                @if (user.activo) {
                                <p-button
                                    icon="pi pi-ban"
                                    severity="secondary"
                                    size="small"
                                    text
                                    (click)="deactivateUser(user)"
                                    title="Desactivar">
                                </p-button>
                                } @else {
                                <p-button
                                    icon="pi pi-check"
                                    severity="success"
                                    size="small"
                                    text
                                    (click)="activateUser(user)"
                                    title="Activar">
                                </p-button>
                                }

                                <p-button
                                    icon="pi pi-key"
                                    severity="info"
                                    size="small"
                                    text
                                    (click)="openChangePasswordDialog(user)"
                                    title="Cambiar Contraseña">
                                </p-button>

                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    size="small"
                                    text
                                    (click)="confirmDeleteUser(user)"
                                    title="Eliminar">
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center p-4">
                            <div
                                class="flex flex-column align-items-center gap-3">
                                <i class="pi pi-users text-4xl text-400"></i>
                                <div>
                                    <h4 class="text-900 font-semibold">No hay
                                        usuarios registrados</h4>
                                    <p class="text-600">Crea el primer usuario
                                        del sistema</p>
                                </div>
                                <p-button
                                    label="Ir a Gestión de Empleados"
                                    icon="pi pi-users"
                                    (click)="navigateToEmployees()"
                                    severity="secondary">
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-template>
    </p-card>

    <!-- Edit User Dialog -->
    <p-dialog
        header="Editar Usuario"
        [visible]="showUserDialog()"
        (visibleChange)="showUserDialog.set($event)"
        [modal]="true"
        [closable]="true"
        [style]="{ width: '500px' }"
        (onHide)="closeUserDialog()">

        <form [formGroup]="userForm" (ngSubmit)="saveUser()">
            <div class="grid">
                @if (selectedUser()) {
                <div class="col-12">
                    <div class="bg-blue-50 p-3 border-round mb-3">
                        <p class="text-sm text-blue-900 m-0">
                            <i class="pi pi-user mr-2"></i>
                            Usuario: <strong>{{ selectedUser()!.username
                                }}</strong> - {{ selectedUser()!.nombreCompleto
                            }}
                        </p>
                    </div>
                </div>
                }

                <div class="col-12">
                    <label for="rol" class="block text-900 font-medium mb-2">Rol
                        *</label>
                    <p-select
                        id="rol"
                        formControlName="rol"
                        [options]="userRoles"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Seleccionar rol"
                        class="w-full">
                    </p-select>
                </div>

                <div class="col-12">
                    <p-divider></p-divider>
                    <div class="flex align-items-center gap-2">
                        <input
                            type="checkbox"
                            id="activo"
                            formControlName="activo"
                            class="mr-2">
                        <label for="activo" class="text-900 font-medium">Usuario
                            activo</label>
                    </div>
                </div>
            </div>
        </form>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cancelar"
                    severity="secondary"
                    text
                    (click)="closeUserDialog()">
                </p-button>
                <p-button
                    label="Actualizar"
                    [loading]="isSaving()"
                    (click)="saveUser()"
                    [disabled]="userForm.invalid">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- Change Password Dialog -->
    <p-dialog
        header="Cambiar Contraseña"
        [visible]="showPasswordDialog()"
        (visibleChange)="showPasswordDialog.set($event)"
        [modal]="true"
        [closable]="true"
        [style]="{ width: '400px' }"
        (onHide)="closePasswordDialog()">

        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <div class="grid">
                <div class="col-12">
                    <label
                        class="block text-900 font-medium mb-2">Usuario</label>
                    <div class="p-inputgroup">
                        <i class="pi pi-user p-inputgroup-addon"></i>
                        <input
                            type="text"
                            pInputText
                            [value]="selectedUser()?.username"
                            readonly
                            class="w-full">
                    </div>
                </div>

                <div class="col-12">
                    <label for="newPassword"
                        class="block text-900 font-medium mb-2">Nueva Contraseña
                        *</label>
                    <p-password
                        id="newPassword"
                        formControlName="newPassword"
                        placeholder="Ingrese la nueva contraseña"
                        [feedback]="true"
                        [toggleMask]="true"
                        class="w-full">
                    </p-password>
                </div>

                <div class="col-12">
                    <label for="confirmPassword"
                        class="block text-900 font-medium mb-2">Confirmar
                        Contraseña *</label>
                    <p-password
                        id="confirmPassword"
                        formControlName="confirmPassword"
                        placeholder="Confirme la nueva contraseña"
                        [toggleMask]="true"
                        class="w-full">
                    </p-password>
                    @if
                    (passwordForm.get('confirmPassword')?.errors?.['mismatch'])
                    {
                    <small class="text-red-500">Las contraseñas no
                        coinciden</small>
                    }
                </div>
            </div>
        </form>

        <ng-template pTemplate="footer">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cancelar"
                    severity="secondary"
                    text
                    (click)="closePasswordDialog()">
                </p-button>
                <p-button
                    label="Cambiar Contraseña"
                    [loading]="isSaving()"
                    (click)="changePassword()"
                    [disabled]="passwordForm.invalid">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>
</div>

<!-- Toast and Confirmation Dialog -->
<p-toast></p-toast>
<p-confirmdialog></p-confirmdialog>